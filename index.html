<!DOCTYPE html>
<html lang="jp">
<head>
<meta charset="UTF-8">
<title>ここにいます</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<link rel="stylesheet" href="css/style.css">
<link rel="icon" type="image/x-icon" href="img/favicon.ico">



</head>
<body>



<h1>ここにいます</h1>

<button id="send">位置情報を知らせる</button>
<button id="delete">クリア</button>
<!-- MAP[START] -->
<div id="myMap" style='width:100%;height:70%;float:left;'></div>
<!-- MAP[END] -->
<footer id="footer">
    <img src="img/logo.png" alt="potz" class="logo"> 

    <a href="infoboxs_showChange.html">徳島ここ行ってみよう/</a>
</footer>
<script src='https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=AnyNxLkldi8EXahD24Eocb7qnVk8EmqW8QMLpYojrc39cX2yZdPH_RONx2gsfF2c' async defer></script>
<script src="js/BmapQuery.js"></script>
<script>
//****************************************************************************************
// BingMaps&BmapQuery
//****************************************************************************************
//Init
let map; // map変数をグローバルスコープに移動
function GetMap(){
    //------------------------------------------------------------------------
    //1. Instance
    //------------------------------------------------------------------------
    map = new Bmap("#myMap"); // グローバルスコープのmap変数に代入

    //------------------------------------------------------------------------
    //2. geolocation: Display Map
    //   map.geolocation(function(data:object){...});
    //------------------------------------------------------------------------
    map.geolocation(function(data) {
        //location
        const lat = data.coords.latitude;
        const lon = data.coords.longitude;
        //Map
        map.startMap(lat, lon, "load", 10);
        //pin
        map.pin(lat,lon,"#ff0000");
    });

}

</script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getDatabase, ref, push, set, update, remove, onChildAdded, onChildChanged, onChildRemoved } 
from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
import firebaseConfig from "./js/firebase.js";
console.log(firebaseConfig);
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db,"map");

function formatTimestamp(date) {
    const y = date.getFullYear();
    const m = ('0' + (date.getMonth() + 1)).slice(-2);
    const d = ('0' + date.getDate()).slice(-2);
    const hour = ('0' + date.getHours()).slice(-2);
    const min = ('0' + date.getMinutes()).slice(-2);
    return `${y}/${m}/${d} ${hour}:${min}`;
  }

  $(document).ready(function() {
    $("#send").on("click", async function() { // async を追加
        map.geolocation(async function(data) { // async を追加
            const lat = data.coords.latitude;
            const lon = data.coords.longitude;
            const now = new Date();
            
            let msg = {
                lat: lat,
                lon: lon,
                timestamp: formatTimestamp(now)
            };
            console.log (lat,lon);
            const newPostRef = push(ref(db, "map"));
            await set(newPostRef, msg);
            // ここでメール送信の処理をトリガーする（
            alert(lat+`メールにて位置情報を送信！`); // このページのURLリンクの予定
        }, function(error) {
            console.error("Geolocation error: ", error);
        }, {
            enableHighAccuracy: true,
            maximumAge: 20000,
            timeout: 10000
        });
    });
});

// 「位置情報削除」ボタンの参照を取得
const deleteAllButton = document.getElementById("delete");

// ボタンのクリックイベントリスナー
deleteAllButton.onclick = function() {
    // 確認ダイアログを表示
    const confirmDelete = confirm("本当に全て削除しますか？この操作は取り消せません。");
    if (confirmDelete) {
        // Firebase Realtime Databaseから全てのメッセージを削除
        db.ref("map/").remove()
        .then(function() {
            console.log("位置履歴全て削除しました。");
            // 必要に応じてUIの更新や通知を行う
        })
        .catch(function(error) {
            console.error("削除中にエラーが発生しました：", error);
        });
    }
};



</script>
</body>
</html>
